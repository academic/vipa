<?php

namespace Ojs\UserBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * UserJournalRoleRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class UserJournalRoleRepository extends EntityRepository
{
    /**
     * get user list of users a journal with journal_id
     * @param $journal_id
     * @param  bool       $grouppedByRole
     * @return array|bool
     */
    public function getUsers($journal_id, $grouppedByRole = false)
    {
        $user_journal_roles = $this->getEntityManager()->getRepository('OjsUserBundle:UserJournalRole')->findByJournalId($journal_id);
        $entites = array();
        if (!is_array($user_journal_roles)) {
            return false;
        }
        foreach ($user_journal_roles as $item) {
            $entites[] = $item->getUser();
        }

        if (!$grouppedByRole) {
            return $entites;
        }

        $users = [];
        foreach ($entites as $user) {
            /** @var User $user */
            foreach ($user->getRoles() as $role) {
                /** @var Role $role */
                if ($role->getIsSystemRole()) {
                    continue;
                }
                $users[$role->getName()][] = $user;
            }
        }

        return $users;
    }

    /**
     * @param int $user_id Use null for all
     * @return array Array structrue: [user_id][journal_id]['roles']
     */
    public function getUsersWithRoles($user_id = null)
    {
        if(is_null($user_id)) {
            $data = $this->getEntityManager()
                ->createQuery('SELECT u FROM OjsUserBundle:UserJournalRole u WHERE u.userId = :user_id')
                ->setParameter('user_id', $user_id)->getResult();
        } else {
            $data = $this->findAll();
        }

        $entities = array();

        if ($data) {
            foreach ($data as $item) {
                if(!$item->getRole()->getIsSystemRole()) {
                    $entities[$item->getUser()->getId()]['id'] = $item->getUser()->getId();
                    $entities[$item->getUser()->getId()]['entity'] = $item->getUser();
                    $entities[$item->getUser()->getId()]['journals'][$item->getJournalId()]['entity'] = $item->getJournal();
                    $entities[$item->getUser()->getId()]['journals'][$item->getJournalId()]['roles'][] = $item->getRole();
                }
            }
        }

        return $entities;
    }
}
